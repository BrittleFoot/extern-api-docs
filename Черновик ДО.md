В этом разделе расскажем про подготовку документов к отправке в контролирующий орган. 

Большинство документов в электронном документообороте являются формализованными. Это значит, что к ним применяется определенный набор форматно-логических контролей на стороне контролирующих органов.  
Чтобы минимизировать возможные причины отказа в приеме документов, мы проводим проверку документов на своей стороне. 

По каналам связи документы передаются в зашифрованном виде, поэтому перед отправкой документы зашифровываются на определенные сертификаты сотрудников контролирующих органов. Ряд документов необходимо перед отправкой сжимать. А ещё ведь хочется видеть красивые печатные формы вместо сложночитаемых xml-файлов документов. Эти и многие другие аспекты работы с документами в электронном документообороте позволят удобно и без лишних затрат реализовать методы API Контур.Экстерна данного раздела.

## Работа с черновиками документооборотов

![Схема](https://github.com/skbkontur/extern-api-docs/blob/master/images/Черновики%20ДО.jpg)

### 1. **Создание**
Начинается всё с создания черновика с помощью метода [POST Draft](#1).

### 2. **Наполнение**
Потом с помощью метода [POST Document](#12) необходимо положить в черновик документы, которые хочется отправить в контролирубщий орган. На этом этапе можно положить документы без подписей, если нужно просто проверить документы на соответствие форматам.

### 3. **Проверка** 
Вызовом метода [POST Check](#6) можно проверить все документы, находящиеся в черновике. Будут выполнены:
* проверка на соответствие формату, то есть xml-файл документа проходит проверку по xsd-схеме
* проверки правильности контрольных соотношений согласно формату документа
* кросс-проверки между документами черновика, например, соответствие подписантов в доверенности и документе

### 4. **Подготовка**

На этом этапе прячется подготовка контента документа к передаче в контролирующий орган. 
У каждого типа контролирующего органа, документооборота и документа есть свои особенности в подготовке контента. Эти особенности  регламентируются различными нормативными документами: какие-то документы надо сжать с применением определенного алгоритма, какие-то документы требуется зашифровать на определенные сертификаты, всё это сильно различается. Но пользователю API об этом знать не нужно, всё это спрятано за методом [POST Prepare](#7). На данном этапе **обязательно** наличие в черновике подписей под документами.

### 5. **Отправка** 

После проверки и подготовки документов настает момент отправки, метод [POST Send](#8). На выходе метода создается документооборот - это можно считать моментом отправки документа в контролирующий орган. Далее идет работа с созданным документооборотом, все данные по нему будут в ответе этого метода.

Базовый сценарий предполагает последовательные вызовы методов создания черновика, наполнение его документами, проверки, подготовки и отправки. Но есть возможность не вызывать методы последовательно, а вызвать сразу подготовку и отправку, или только отправку. При этом стоит понимать, что под капотом всё-таки будут вызваны и предыдущие методы тоже. Например, вызываешь Подготовку, то Проверка вызывается автоматически перед ней. Вызываешь Отправку, а под капотом вызываются и Проверка, и Подготовка. Работа может завершиться на любом из методов, если тот вернет неудовлетворительный ответ. Таким образом, ни при каком условии мы не допускаем отправку непроверенных документов в контролирующий орган, тем самым минимизируем вероятность отказа в приеме документов.

## Методы API Контур.Экстерна для работы с черновиками документооборотов
Подробная спецификация методов показана в сваггере в разделе [Drafts](http://extern-api.testkontur.ru/swagger/ui/index#/Drafts).

Список доступных методов:
* [Создание черновика](#1)
* [Удаление черновика](#2)
* [Получение черновика](#3)
* [Получение описания черновика](#4)
* [Редактирование описания черновика](#5)
* [Проверка документов в черновике](#6)
* [Подготовка документов в черновике к отправке](#7)
* [Отправка документов из черновика](#8)
* [Удаление документа](#9)
* [Получение документа](#10)
* [Редактирование документа](#18)
* [Получение печатной формы документа](#11)
* [Добавление документа](#12)
* [Получение расшифрованного контента документа](#13)
* [Запись контента документа](#14)
* [Получение зашифрованного контента документа](#15)
* [Получение подписи под документом](#16)
* [Добавление подписи под документ](#17)
* [Печать документа](#19)
* [Формирование декларации](#20)

<a name="1"></a>
### Создание черновика 
Метод: [POST Draft](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_Create)

С помощью этого метода создается черновик с минимально необходимым набором мета-информации, который в будущем можно при необходимости отредактировать или дополнить, используя метод [PUT Meta](#5)
------
<a name="2"></a>
### Удаление черновика 
Метод: [DELETE Draft](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_DeleteDraft)
------
<a name="3"></a>
### Получение черновика 
Метод: [GET Draft](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_GetDraft)

В ответ на вызов данного метода можно получить всю аткуальную информацию по черновику:
* заполненную на данный момент мета-инфомарцию
* перечень находящихся в черновике документов
* статус черновика (новый, проверен, готов к отправке или отправлен)

Если черновик уже был отправлен, то будет ссылка на созданный документооборот.

<a name="4"></a>
### Получение описания черновика 
Метод: [GET Meta](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_GetMeta)

Получение только мета-информации черновика.

<a name="5"></a>
### Редактирование описания черновика 
Метод: [PUT Meta](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_UpdateDraftMeta)

<a name="6"></a>
### Проверка документов в черновике 
Метод: [POST Check](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_Check)

Вызовом данного метода можно проверить все документы, находящиеся в черновике. Документы проходят форматно-логические контроли по отдельности, но при наличии нескольких документов в черновике или подписей к документам возможно проведение кросс-проверок, то есть проверок на соответствие документов и подписей между собой.

<a name="7"></a>
### Подготовка документов в черновике к отправке 
Метод: [POST Prepare](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_Prepare)

С помощью данного метода документы подготавливаются к транспортировке их в контролирующий орган: происходит их шифрование и сжатие согласно транспортным протоколам.

<a name="8"></a>
### Отправка документов из черновика 
Метод: [POST Send](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/Drafts_Send)

На выходе данного метода получается документооборот, с которым продолжается работа с помощью методов блока [Docflows](https://github.com/skbkontur/extern-api-docs/blob/master/Работа%20с%20ДО.md).

<a name="9"></a>
### Удаление документа 
Метод: [DELETE Document](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_DeleteDocument)

<a name="10"></a>
### Получение документа 
Метод: [GET DocumentAsync](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_GetDocumentAsync)

С помощью данного метода можно получить конкретный документ из черновика, с его мета-информацией и контентами самого документа и подписи, если она уже была добавлена

<a name="18"></a>
### Редактирование документа 
Метод: [PUT Document](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_PutDocument)

Используется для добавления каких-либо данных в документ, например, добавление подписи к нему.

<a name="11"></a>
### Получение печатной формы документа 
Метод: [GET DocumentPrint](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_GetDocumentPrint)

<a name="12"></a>
### Добавление документа 
Метод: [POST Document](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_AddDocument)

Допускается добавление документа без подписи. Например, вы не уверены в валидности сформированного xml-файла документа, и чтобы не генерировать лишний раз подпись к нему, хотите сначала его проверить отдельно. И если проверка прошла успешно, то подпись можно отдельно добавить к документу с помощью метода [PUT DocumentSignature](#19)

<a name="13"></a>
### Получение расшифрованного контента документа 
Метод: [GET DocumentContent](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_GetDocumentContent)

<a name="14"></a>
### Запись контента документа 
Метод: [PUT DocumentContent](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_PutDocumentContent)

<a name="15"></a>
### Получение зашифрованного контента документа 
Метод: [GET EncryptedDocumentContent](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_GetEncryptedDocumentContent)

Если над черновиком был вызван метод [POST Prepare](#7), то в черновике появился зашифрованный контент документа, с помощью данного метода его можно получить

<a name="16"></a>
### Получение подписи под документом 
Метод: [GET SignatureContent](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_GetSignatureContent)

<a name="17"></a>
### Добавление подписи под документ 
Метод: [PUT DocumentSignature](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_PutDocumentSignature)

<a name="19"></a>
### Печать документа
Метод: [GET DocumentPrintAsync](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_GetDocumentPrintAsync)

Метод позволяет получить печатную форму любого формализованного документа в черновике.

<a name="20"></a>
### Формирование декларации
Методы: 
* [POST BuildContentFromFormat-V1](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_BuildContentFromFormat)
* [POST BuildContentFromFormat-V2](http://extern-api.testkontur.ru/swagger/ui/index#!/Drafts/DraftDocuments_BuildContentFromFormat_0)

С помощью метода возможно получить xml-файл деклараций по Упрощенной системы налогообложения по ставке 6% и 15%, передав определенный контракт с данными, на основе которых необходимо сформировать декларацию. 

Контракты:
* V1 - [УСН-6](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/usn6%20-v1.json), [УСН-15](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/usn15%20-v1.json)
* V2 - [УСН-6](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/usn6%20-v2.json), [УСН-15](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/usn15%20-v2.json)
