# Метод доверительной аутентификации
![Схема](images/Доверительная.jpg)

Доверительная аутентификация двухшаговая.

## 1. Инициализация
* доверенная система (клиент) отправляет идентификатор своего пользователя (*serviceUserId*)
* подписывает данные запроса своим ключом (открытый сертификат данного ключа необходимо передать в Контур, он будет использовать для проверки подписи запроса на нашей стороне), на этом шаге допускается возможность использования криптографии [RSA](https://ru.wikipedia.org/wiki/RSA), сертификат и ключ для данного алгоритма криптографии можно получить в ОС Windows[→](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/RSA%20certs.md), примеры работы с использованием OpenSSL[→](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/using%20OpenSSL%20+%20RSA.md)
* сервер формирует случайный ключ (*rnd*) и передает его доверенной системе

**Запрос**: ```POST /auth/v5.9/authenticate-by-truster?apiKey=value&credential=value&timestamp=value&serviceUserId=value ```, где:
* serviceUserId - идентификатор пользователя в доверенном системе.
* apiKey - [api-key](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/api-key.md).
* credential  - объект идентификации может принимать значения:
    * thumbprint - отпечаток сертификата для идентификации пользователя.
    * phone - 10-значный номер телефона для идентификации пользователя.
    * snils - 11-значный СНИЛС для идентификации пользователя.
* timestamp -  метка времени

**Тело запроса**: открепленная подпись, передается в виде массива байтов без всякого дополнительного кодирования, подписываются следующие данные (кодировка UTF-8): ```string.Format("apikey={0}\r\nid={1}\r\ntimestamp={2}\r\n", ApiKey.ToLower(), Id, Timestamp)```, где:
* apiKey -  [api-key](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/api-key.md) в нижнем регистре,
* id - объект идентификации, параметр credential из query-string запроса,
* timestamp -  метка времени (в формате "dd.MM.yyyy HH:mm:ss", время GMT)

Подпись должна быть сформирована в соответствии с требованиями PKCS#7: при формировании подписи подписывается результат выполнения hash-функции, соответствующей сертификату, над данными строки, после чего он оборачивается в соответствии с PKCS#7.

**Ответ**:
* Key - случайная строка.
* Link - объект, который описывает ссылку для подтверждения запроса аутентификации:
    * Link.Rel - описание ссылки,
    * Link.Href - адрес ссылки.
    
**Коды ответов**:
* 200(OK) - запрос выполнен успешно
* 400(Bad Request) 
* 401(Unauthorized) - api-key не указан 
* 403(Forbidden)[→](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/403%20(Forbidden)%20от%20auth.api.md)
* 500(InternalServerError)

## 2. Подтверждение
* Доверенная система, получив случайное значение *rnd* генерирует запрос, где в параметре указывает этот *rnd*.
* Сервер проверяет тот ли этот *rnd*, который он отправлял ранее, в случае успеха отдает auth.sid.

**Запрос**: ```POST /auth/v5.9/approve-truster?key=value&id=value&apiKey=value ```, где:
* key - случайное значение *rnd*.
* apiKey - [api-key](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/api-key.md).
* id - объект идентификации, параметр credential из query-string запроса Инициализации

**Ответ**:
* Sid - идентификатор сессии [auth.sid](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/auth.sid.md).

**Коды ответов**:
* 200(OK) - запрос выполнен успешно
* 400(Bad Request) - отсутствуют необходимые параметры
* 401(Unauthorized) - api-key не указан 
* 403(Forbidden)[→](https://github.com/skbkontur/extern-api-docs/blob/master/manuals/403%20(Forbidden)%20от%20auth.api.md)
* 500(InternalServerError)
